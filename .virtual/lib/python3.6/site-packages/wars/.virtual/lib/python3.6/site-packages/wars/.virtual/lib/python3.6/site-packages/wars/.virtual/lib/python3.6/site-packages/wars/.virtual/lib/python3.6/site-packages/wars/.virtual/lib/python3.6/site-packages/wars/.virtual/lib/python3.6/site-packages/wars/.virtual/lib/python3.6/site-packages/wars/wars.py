#!/usr/bin/python

from __future__ import unicode_literals
import requests, sqlite3
import json
from requests.auth import HTTPBasicAuth
import datetime

database = sqlite3.connect("newdata.db")
cursor = database.cursor()

def json_serial(obj):

    if isinstance(obj, (datetime.datetime, datetime.date)):
        return obj.isoformat()
    raise TypeError ("Type %s not serializable" % type(obj))

d = requests.get("https://api.ona.io/api/v1/data/661402", auth = HTTPBasicAuth('mike@upande.com', 'itwaruchiu'))
dnew = json.loads(d.text)

time_var = json_serial(datetime.datetime(1970,1,1))

table_id = 661402

ona_url ='https://api.ona.io/api/v1/data/'

auth_set = ('mike@upande.com','itwaruchiu')

for i in dnew:
    late_date = i.get('_submission_time')
    if late_date >= time_var:
        time_var = late_date
    else:
        time_var = time_var

query_str ={"_submission_time":{"$gte":time_var}}

request_url = ona_url+str(table_id)+'?query='+json.dumps(query_str)

response = json.loads(requests.get(
    request_url,
    auth=auth_set
).text)

print(response)

for i in response:
    name = (i.get('What_is_your_name'))
    occupation = (i.get('What_is_your_occupation'))

cursor.execute("INSERT INTO newtable (name, occupation) VALUES (?, ?);", (name,occupation))
database.commit()